# 附录: Natapp 内网穿透详细教程

本文档旨在为 `Brotato-Qt` 项目的使用者提供一份清晰、完整的 **Natapp** 内网穿透工具配置指南。为了让本项目的DLC支付系统能接收到来自支付宝服务器的**异步回调通知**，我们需要将运行在本地的Python Flask服务器（通常在 `localhost:5000`）暴露到公网上。Natapp是一个能轻松实现此功能的优秀工具。

## 1. 为什么需要内网穿透？

- **支付宝的回调机制**: 当用户在沙箱环境扫码支付成功后，支付宝的服务器需要主动向我们的Python后端发送一个HTTP POST请求，告知我们“这笔订单已经支付成功了”。
- **公网地址**: 支付宝的服务器位于公网，它无法直接访问您个人电脑上的 `127.0.0.1` 或 `localhost`。
- **Natapp的角色**: Natapp的作用就像一个“信使”。它会提供一个公网可以访问的网址（例如 `http://xxxx.natappfree.cc`），然后将所有发送到这个网址的请求，都安全地“穿透”您的内网，转发到您本地正在运行的 `localhost:5000` 服务上。

## 2. 操作步骤

### 第一步：注册并登录 Natapp

1. 访问 [Natapp 官方网站](https://natapp.cn/)。
2. 点击右上角的“注册”按钮，完成账户注册。
3. 注册完成后，登录您的Natapp账户。

### 第二步：购买免费隧道

Natapp为所有用户提供了免费的隧道，对于我们的实训项目来说完全够用。

1. 登录后，在左侧菜单栏中选择 **“购买隧道”** -> **“购买免费隧道”**。
2. 在弹出的列表中，选择一个“VIP 0级 免费隧道”并点击“立即购买”（价格为0元）。
3. 购买成功后，您就拥有了一条可以配置的免费隧道。

### 第三步：配置隧道

1. 在左侧菜单栏中选择 **“我的隧道”**。您会看到刚刚购买的免费隧道。
2. 点击隧道右侧的 **“配置”** 按钮。
3. 在配置页面，您需要填写以下关键信息：
   - **隧道协议**: 选择 `Web`。
   - **本地端口**: 填写 `5000` (这是我们 `app.py` Flask服务器运行的端口)。
   - 其他选项（如隧道名称）可以自定义或保持默认。
4. 填写完毕后，点击“确认修改”保存配置。


### 第四步：获取 Authtoken

`Authtoken` 是连接您的客户端和Natapp服务器的凭证。

1. 在左侧菜单栏中选择 **“我的隧道”**。
2. 在页面上您可以看到一长串由字母和数字组成的 **`authtoken`**。
3. 点击旁边的“复制”按钮，将它保存好，我们马上会用到。

### 第五步：下载并运行 Natapp 客户端

1. 在左侧菜单栏中选择 **“客户端下载”**。

2. 根据您的操作系统（Windows, macOS, Linux）下载对应的客户端程序。它是一个无需安装的单个可执行文件。

3. 将下载的 `natapp.exe` (或 `natapp`) 文件放到您项目的根目录，或者任何您方便找到的地方。

4. **启动隧道**：

   - 打开您电脑的**命令行终端** (Windows上是 `cmd` 或 `PowerShell`, macOS/Linux上是 `Terminal`)。
   - 使用 `cd` 命令进入 `natapp` 客户端所在的目录。
   - 执行以下命令来启动隧道，记得将 `你的AUTHTOKEN` 替换为您在第四步中复制的真实 `authtoken`：

   ```
   # Windows
   natapp.exe -authtoken=你的AUTHTOKEN
   
   # macOS / Linux
   ./natapp -authtoken=你的AUTHTOKEN
   ```

5. **查看结果**：

   - 命令执行后，如果一切正常，终端会显示类似下面的信息：

   ```
   Tunnel Status                 Online
   Version                       x.x.x/x.x.x
   Forwarding                    http://xxxx.natappfree.cc -> 127.0.0.1:5000
   ```

   - 这里的 `http://xxxx.natappfree.cc` 就是您获得的**公网地址**。请复制这个地址。

### 第六步：配置并启动Python服务器

1. 打开项目中的 `app.py` 文件。

2. 找到 `PUBLIC_DOMAIN` 变量，将它的值修改为您在第五步中获得的公网地址。

   ```
   # app.py
   # 将这里的URL替换成你自己的Natapp公网地址
   PUBLIC_DOMAIN = "http://xxxx.natappfree.cc"
   ```

3. 保存文件。

4. 在**另一个新开的**命令行终端中，进入项目根目录，启动Python服务器：

   ```
   python app.py
   ```

至此，您的本地服务器已经成功通过Natapp暴露到公网。现在，当您在游戏中进行支付时，支付宝服务器就能通过您的公网地址，将支付成功的回调通知发送到您本地运行的 `app.py` 了。

> **⚠️ 重要提示**:
>
> - 运行 Natapp 和 Python 服务器需要**保持两个命令行窗口都处于打开状态**。
> - 免费隧道的公网地址是**动态的**，每次重新运行 Natapp 客户端，地址都可能会改变。如果改变了，请记得同步修改 `app.py` 中的 `PUBLIC_DOMAIN` 变量。